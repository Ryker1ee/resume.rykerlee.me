<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ryker Lee - Courses</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <!-- NAV -->
  <nav>
    <div class="nav-wrapper">
      <div class="nav-container">
        <a href="index.html">Home</a>
        <a href="experience.html">Experience</a>
        <a class="active" href="courses.html">Courses</a>
        <a href="projects.html">Projects</a>
      </div>
    </div>
  </nav>

  <!-- MAIN COURSES CONTENT -->
  <main class="container" id="courses-root">
    <h1>Courses</h1>
    <!-- The script will render grouped sections here -->
  </main>

  <script>
    // --- helpers ---
    const esc = s => String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));

    // Spring=0, Summer=1, Fall=2; higher year/term means newer
    function termKey(termStr){
      const m = (termStr || '').match(/(Spring|Summer|Fall)\s+(\d{4})/i);
      if (!m) return { year: 0, termIndex: -1 };
      const map = { spring:0, summer:1, fall:2 };
      return { year: parseInt(m[2],10), termIndex: map[m[1].toLowerCase()] ?? -1 };
    }

    // Extract numeric, e.g. "CSC 420" -> 420
    function codeNum(code){
      const m = String(code || '').match(/(\d{2,4})/);
      return m ? parseInt(m[1], 10) : 0;
    }

    function liHTML(c){
      const left = (c.code ? esc(c.code) + ': ' : '') +
                   `<span class="course-title">${esc(c.title || 'Untitled Course')}</span>`;
      const pills = [];
      if (c.category) pills.push(`<span class="pill">${esc(c.category)}</span>`);
      if (c.term)     pills.push(`<span class="pill">${esc(c.term)}</span>`);
      if (typeof c.credits === 'number') pills.push(`<span class="pill">${esc(c.credits)} cr</span>`);
      return `<li>${left} <span class="meta">${pills.join(' ')}</span></li>`;
    }

    function renderCard(parent, title, items){
      if (!items.length) return;
      const card = document.createElement('div');
      card.className = 'course-card';
      const h3 = document.createElement('h3');
      h3.textContent = title;
      card.appendChild(h3);
      const ul = document.createElement('ul');
      ul.className = 'course-list';
      ul.innerHTML = items.map(liHTML).join('');
      card.appendChild(ul);
      parent.appendChild(card);
    }

    function renderBucket(root, bucketTitle, bucket){
      const sec = document.createElement('section');
      const h2 = document.createElement('h2');
      h2.textContent = bucketTitle;
      sec.appendChild(h2);

      renderCard(sec, 'Currently Taking', bucket.in_progress);
      renderCard(sec, 'Completed', bucket.completed);

      root.appendChild(sec);
    }

    // --- main ---
    fetch('database.json')
      .then(r => {
        if (!r.ok) throw new Error('Failed to load database.json');
        return r.json();
      })
      .then(db => {
        const root = document.getElementById('courses-root');
        const courses = Array.isArray(db.courses) ? db.courses : [];

        // Buckets by prefix + status
        const buckets = {
          CSC:   { in_progress: [], completed: [] },
          Other: { in_progress: [], completed: [] }
        };

        for (const c of courses){
          const isCSC   = /^CSC\b/i.test(c.code || '');
          const status  = String(c.status || '').toLowerCase(); // 'in_progress' or 'completed'
          const dest    = isCSC ? buckets.CSC : buckets.Other;
          if (status === 'in_progress') dest.in_progress.push(c);
          else if (status === 'completed') dest.completed.push(c);
        }

        // Sort: CSC by numeric code; Other by newest term then code
        const byCSCNum = (a,b) => codeNum(a.code) - codeNum(b.code);
        const byTermThenCode = (a,b) => {
          const ka = termKey(a.term), kb = termKey(b.term);
          if (kb.year !== ka.year) return kb.year - ka.year;
          if (kb.termIndex !== ka.termIndex) return kb.termIndex - ka.termIndex;
          return String(a.code||'').localeCompare(String(b.code||''));
        };

        buckets.CSC.in_progress.sort(byCSCNum);
        buckets.CSC.completed.sort(byCSCNum);
        buckets.Other.in_progress.sort(byTermThenCode);
        buckets.Other.completed.sort(byTermThenCode);

        // Render two grouped sections
        renderBucket(root, 'CSC', buckets.CSC);
        renderBucket(root, 'Other', buckets.Other);
      })
      .catch(err => {
        console.error(err);
        const root = document.getElementById('courses-root');
        root.innerHTML += '<p>Could not load courses.</p>';
      });
  </script>
</body>
</html>
